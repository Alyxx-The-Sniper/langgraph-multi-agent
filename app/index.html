<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent AI Support Demo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        body { font-family: 'Inter', sans-serif; }

        /* Custom scrollbar for chat history */
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }

        /* Markdown Styling for AI Bubbles */
        .markdown-content a { color: #2563eb; text-decoration: underline; font-weight: 600; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content code { background: rgba(0,0,0,0.05); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center h-screen p-4">

    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-3xl flex flex-col h-[90vh] border border-slate-200 overflow-hidden">
        <header class="bg-indigo-600 p-5 text-white shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Multi-Agent Support System</h1>
                    <p id="status-text" class="text-indigo-100 text-xs mt-1">Ready to assist</p>
                </div>
                <div id="thread-badge" class="hidden bg-indigo-500 text-[10px] px-2 py-1 rounded-full border border-indigo-400">
                    ID: <span id="thread-id-display"></span>
                </div>
            </div>
        </header>

        <div id="chat-history" class="flex-grow p-6 overflow-y-auto space-y-6 bg-slate-50/50">
            <div class="flex justify-start">
                <div class="bg-white border border-slate-200 text-slate-700 p-4 rounded-2xl rounded-bl-none shadow-sm max-w-[85%]">
                    <p class="font-semibold text-indigo-600 mb-2">System Initialized</p>
                    <p class="text-sm leading-relaxed">I am an AI orchestrator connected to **Airtable** and **Slack**. I can track orders, process refunds, or escalate your case to a human agent if you need a modification.</p>
                    <p class="font-semibold text-indigo-600 mb-2">Example Queries:</p>
                    <p class="text-sm leading-relaxed">1. Whats the status of my order tracking number 3.</p>
                    <p class="text-sm leading-relaxed">2. I want to cancel my order</p>
                </div>
            </div>
        </div>

        <form id="chat-form" class="p-4 bg-white border-t border-slate-100 flex gap-3">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Ask about your order or request a cancellation..."
                class="flex-grow px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm"
                required
            />
            <button type="submit" id="send-btn" class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 flex items-center gap-2">
                <span>Send</span>
                <div id="spinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
            </button>
        </form>
    </div>

    <script>
        // const API_URL = "http://127.0.0.1:8000"; // Ensure this matches your Uvicorn host --> For local deployment
        const API_URL = "https://langgraph-multi-agent.up.railway.app"; 
        const CHAT_STREAM_ENDPOINT = `${API_URL}/chat/stream`;
        const chatForm = document.getElementById('chat-form');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const spinner = document.getElementById('spinner');
        const threadIdDisplay = document.getElementById('thread-id-display');
        const threadBadge = document.getElementById('thread-badge');

        let currentThreadId = null;

        // Configure Markdown
        marked.setOptions({ gfm: true, breaks: true });

        function createBubble(type, content) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'} w-full animate-in fade-in slide-in-from-bottom-2 duration-300`;

            const bubble = document.createElement('div');
            let colorClasses = "bg-white border border-slate-200 text-slate-800";
            
            if (type === 'user') colorClasses = "bg-indigo-600 text-white shadow-indigo-100";
            if (type === 'plan') colorClasses = "bg-amber-50 border-amber-200 text-amber-900 text-xs italic";
            if (type === 'report') colorClasses = "bg-emerald-50 border-emerald-200 text-emerald-900 text-xs";

            bubble.className = `p-4 rounded-2xl shadow-sm max-w-[85%] markdown-content ${colorClasses} ${type === 'user' ? 'rounded-tr-none' : 'rounded-bl-none'}`;
            
            // Render Markdown
            bubble.innerHTML = type === 'user' ? content : marked.parse(content);

            wrapper.appendChild(bubble);
            chatHistory.appendChild(wrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query) return;

            createBubble('user', query);
            userInput.value = '';
            
            // UI State
            sendBtn.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, thread_id: currentThreadId })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop();

                    for (const part of parts) {
                        if (!part.trim()) continue;
                        const eventMatch = part.match(/event: (.+)/);
                        const dataMatch = part.match(/data: (.+)/);

                        if (eventMatch && dataMatch) {
                            const event = eventMatch[1].trim();
                            const data = JSON.parse(dataMatch[1].trim());

                            if (event === 'new_thread') {
                                currentThreadId = data.thread_id;
                                threadIdDisplay.innerText = currentThreadId;
                                threadBadge.classList.remove('hidden');
                            } else if (event === 'supervisor_plan') {
                                createBubble('plan', `**Supervisor Decision:** Routing to the **${data.team}** specialist.`);
                            } else if (event === 'team_report') {
                                createBubble('report', `**Specialist Report:** ${data.content}`);
                            } else if (event === 'final_answer') {
                                createBubble('ai', data.content);
                            }
                        }
                    }
                }
            } catch (err) {
                createBubble('ai', "⚠️ **Connection Error:** Could not reach the AI server.");
            } finally {
                sendBtn.disabled = false;
                spinner.classList.add('hidden');
            }
        };
    </script>
</body>
</html>